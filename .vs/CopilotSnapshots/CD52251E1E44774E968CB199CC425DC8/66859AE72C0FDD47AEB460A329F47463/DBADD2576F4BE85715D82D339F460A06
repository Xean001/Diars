using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using RunaTalento.Data;
using RunaTalento.Models;

namespace RunaTalento.Controllers
{
    /// <summary>
    /// Controlador para CU03 - Consultar Perfil
    /// Permite al estudiante revisar su información personal, logros y medallas
    /// </summary>
    [Authorize(Roles = "Estudiante")]
    public class PerfilController : Controller
    {
        private readonly ApplicationDbContext _context;
        private readonly UserManager<ApplicationUser> _userManager;

        public PerfilController(ApplicationDbContext context, UserManager<ApplicationUser> userManager)
        {
            _context = context;
            _userManager = userManager;
        }

        // GET: Perfil
        public async Task<IActionResult> Index()
        {
            try
            {
                // Obtener el usuario actual
                var userId = _userManager.GetUserId(User);
                var estudiante = await _context.Users
                    .Include(u => u.IdNivel != null ? 
                        _context.Nivel.FirstOrDefault(n => n.IdNivel == u.IdNivel) : null)
                    .FirstOrDefaultAsync(u => u.Id == userId);

                if (estudiante == null)
                {
                    TempData["Error"] = "Error al cargar los datos del perfil";
                    return RedirectToAction("Index", "Home");
                }

                // Obtener medallas del estudiante
                var medallas = await _context.MedallaEstudiante
                    .Include(me => me.Medalla)
                    .Where(me => me.IdEstudiante == userId)
                    .OrderByDescending(me => me.FechaOtorgada)
                    .ToListAsync();

                // Obtener actividades completadas
                var actividadesCompletadas = await _context.ActividadEstudiante
                    .Include(ae => ae.Actividad)
                    .ThenInclude(a => a.Curso)
                    .Where(ae => ae.IdEstudiante == userId)
                    .OrderByDescending(ae => ae.FechaEntrega)
                    .ToListAsync();

                // Obtener nivel actual
                Nivel? nivelActual = null;
                if (estudiante.IdNivel.HasValue)
                {
                    nivelActual = await _context.Nivel.FindAsync(estudiante.IdNivel.Value);
                }

                // Calcular siguiente nivel
                var siguienteNivel = await _context.Nivel
                    .Where(n => n.PuntajeMinimo > estudiante.PuntajeTotal)
                    .OrderBy(n => n.PuntajeMinimo)
                    .FirstOrDefaultAsync();

                // Crear ViewBag con los datos
                ViewBag.Estudiante = estudiante;
                ViewBag.Medallas = medallas;
                ViewBag.ActividadesCompletadas = actividadesCompletadas;
                ViewBag.NivelActual = nivelActual;
                ViewBag.SiguienteNivel = siguienteNivel;
                ViewBag.TotalActividades = actividadesCompletadas.Count;
                ViewBag.TotalMedallas = medallas.Count;

                // Calcular porcentaje para el siguiente nivel
                if (siguienteNivel != null && nivelActual != null)
                {
                    var puntajeEnRango = estudiante.PuntajeTotal - nivelActual.PuntajeMinimo;
                    var rangoTotal = siguienteNivel.PuntajeMinimo - nivelActual.PuntajeMinimo;
                    ViewBag.PorcentajeProgresoNivel = rangoTotal > 0 ? 
                        (int)((puntajeEnRango * 100.0) / rangoTotal) : 0;
                }
                else
                {
                    ViewBag.PorcentajeProgresoNivel = 100;
                }

                return View();
            }
            catch (Exception ex)
            {
                TempData["Error"] = "Error al cargar los datos del perfil: " + ex.Message;
                return RedirectToAction("Index", "Home");
            }
        }
    }
}
