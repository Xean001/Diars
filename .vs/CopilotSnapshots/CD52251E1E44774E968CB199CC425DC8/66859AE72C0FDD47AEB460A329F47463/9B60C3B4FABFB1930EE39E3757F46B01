using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using RunaTalento.Data;
using RunaTalento.Models;

namespace RunaTalento.Controllers
{
    /// <summary>
    /// Controlador para que los estudiantes vean y realicen actividades
    /// </summary>
    [Authorize(Roles = "Estudiante")]
    public class ActividadesEstudianteController : Controller
    {
        private readonly ApplicationDbContext _context;
        private readonly UserManager<ApplicationUser> _userManager;

        public ActividadesEstudianteController(ApplicationDbContext context, UserManager<ApplicationUser> userManager)
        {
            _context = context;
            _userManager = userManager;
        }

        // GET: ActividadesEstudiante
        public async Task<IActionResult> Index()
        {
            var userId = _userManager.GetUserId(User);

            // Obtener todas las actividades con información de si el estudiante ya las completó
            var actividades = await _context.Actividad
                .Include(a => a.Curso)
                .ThenInclude(c => c.Docente)
                .Select(a => new
                {
                    Actividad = a,
                    ActividadEstudiante = _context.ActividadEstudiante
                        .FirstOrDefault(ae => ae.IdActividad == a.IdActividad && ae.IdEstudiante == userId)
                })
                .ToListAsync();

            ViewBag.UserId = userId;
            return View(actividades);
        }

        // GET: ActividadesEstudiante/Details/5
        public async Task<IActionResult> Details(int? id)
        {
            if (id == null)
            {
                return NotFound();
            }

            var userId = _userManager.GetUserId(User);

            var actividad = await _context.Actividad
                .Include(a => a.Curso)
                .ThenInclude(c => c.Docente)
                .FirstOrDefaultAsync(m => m.IdActividad == id);

            if (actividad == null)
            {
                return NotFound();
            }

            // Verificar si el estudiante ya completó esta actividad
            var actividadEstudiante = await _context.ActividadEstudiante
                .FirstOrDefaultAsync(ae => ae.IdActividad == id && ae.IdEstudiante == userId);

            ViewBag.ActividadEstudiante = actividadEstudiante;
            ViewBag.YaCompletada = actividadEstudiante != null;

            return View(actividad);
        }

        // GET: ActividadesEstudiante/Realizar/5
        public async Task<IActionResult> Realizar(int? id)
        {
            if (id == null)
            {
                return NotFound();
            }

            var userId = _userManager.GetUserId(User);

            // Verificar si ya completó la actividad
            var yaCompletada = await _context.ActividadEstudiante
                .AnyAsync(ae => ae.IdActividad == id && ae.IdEstudiante == userId);

            if (yaCompletada)
            {
                TempData["Warning"] = "Ya has completado esta actividad";
                return RedirectToAction(nameof(Index));
            }

            var actividad = await _context.Actividad
                .Include(a => a.Curso)
                .FirstOrDefaultAsync(m => m.IdActividad == id);

            if (actividad == null)
            {
                return NotFound();
            }

            return View(actividad);
        }

        // POST: ActividadesEstudiante/Realizar/5
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Realizar(int id, IFormFile? archivoEntrega)
        {
            var userId = _userManager.GetUserId(User);

            // Verificar que la actividad existe
            var actividad = await _context.Actividad.FindAsync(id);
            if (actividad == null)
            {
                return NotFound();
            }

            // Verificar si ya completó la actividad
            var yaCompletada = await _context.ActividadEstudiante
                .AnyAsync(ae => ae.IdActividad == id && ae.IdEstudiante == userId);

            if (yaCompletada)
            {
                TempData["Warning"] = "Ya has completado esta actividad";
                return RedirectToAction(nameof(Index));
            }

            // Crear la entrega
            var actividadEstudiante = new ActividadEstudiante
            {
                IdActividad = id,
                IdEstudiante = userId,
                FechaEntrega = DateTime.Now,
                PuntajeObtenido = null // El docente lo calificará después
            };

            // TODO: Implementar subida de archivo si es necesario
            // if (archivoEntrega != null)
            // {
            //     var uploadsFolder = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "uploads");
            //     var uniqueFileName = Guid.NewGuid().ToString() + "_" + archivoEntrega.FileName;
            //     var filePath = Path.Combine(uploadsFolder, uniqueFileName);
            //     using (var fileStream = new FileStream(filePath, FileMode.Create))
            //     {
            //         await archivoEntrega.CopyToAsync(fileStream);
            //     }
            //     actividadEstudiante.ArchivoUrl = "/uploads/" + uniqueFileName;
            // }

            _context.ActividadEstudiante.Add(actividadEstudiante);
            await _context.SaveChangesAsync();

            TempData["Success"] = "Actividad completada exitosamente. El docente la calificará pronto.";
            return RedirectToAction(nameof(Index));
        }
    }
}
