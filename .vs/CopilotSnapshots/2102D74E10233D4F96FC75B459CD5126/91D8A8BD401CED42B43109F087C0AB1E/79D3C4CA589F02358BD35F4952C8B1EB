@model dynamic

@{
    ViewData["Title"] = "Ranking de Estudiantes";
    Layout = User.IsInRole("Estudiante") ? "~/Views/Shared/_LayoutEstudiante.cshtml" : "~/Views/Shared/_Layout.cshtml";
}

@if (User.IsInRole("Estudiante"))
{
    <!-- Vista estilo estudiante -->
    <div class="seccion-header">
        <h2>
            <i class="bi bi-graph-up-arrow"></i>
            Ranking de Estudiantes
        </h2>
        <p>Visualiza el desempeño general de todos los estudiantes</p>
    </div>
}
else
{
    <div class="row">
        <div class="col-12 mb-4">
            <h2 class="mb-1">
                <i class="bi bi-graph-up-arrow text-purple"></i> 
                Ranking de Estudiantes
            </h2>
            <p class="text-muted">Top 100 estudiantes con mayor puntaje</p>
        </div>
    </div>
}

@if (Model != null && Model.Count > 0)
{
    @{
        var currentUserId = User.Identity?.IsAuthenticated == true ? 
            Context.RequestServices.GetService<Microsoft.AspNetCore.Identity.UserManager<RunaTalento.Models.ApplicationUser>>()!
            .GetUserId(User) : null;
    }

    <div class="row">
        <div class="col-12">
            <div class="@(User.IsInRole("Estudiante") ? "perfil-section" : "card shadow-sm border-0")">
                @if (!User.IsInRole("Estudiante"))
                {
                    <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                        <h4 class="mb-0"><i class="bi bi-trophy-fill"></i> Tabla de Posiciones</h4>
                    </div>
                }
                <div class="@(User.IsInRole("Estudiante") ? "" : "card-body p-0")">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-center" style="width: 100px;">Posición</th>
                                    <th>Estudiante</th>
                                    <th class="text-center">Puntaje Total</th>
                                    <th class="text-center">Nivel</th>
                                    <th class="text-center">Medallas</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (int i = 0; i < Model.Count; i++)
                                {
                                    var estudiante = Model[i];
                                    var posicion = i + 1;
                                    var badgeClass = posicion == 1 ? "bg-warning text-dark" : 
                                                   posicion == 2 ? "bg-secondary text-white" : 
                                                   posicion == 3 ? "bg-danger text-white" : "bg-primary text-white";
                                    var icon = posicion <= 3 ? "bi-trophy-fill" : "bi-hash";
                                    
                                    // Determinar si es el usuario actual
                                    var isCurrentUser = currentUserId != null && estudiante.Id == currentUserId;
                                    var rowClass = isCurrentUser ? "table-active" : (posicion <= 3 ? "fw-semibold" : "");

                                    <tr class="@rowClass">
                                        <td class="text-center">
                                            <span class="badge @badgeClass fs-6 px-3 py-2">
                                                <i class="bi @icon"></i> @posicion
                                            </span>
                                        </td>
                                        <td class="py-3">
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-sm me-3">
                                                    @{
                                                        var nombres = estudiante.Nombres?.Split(' ');
                                                        var apellidos = estudiante.Apellidos?.Split(' ');
                                                        var iniciales = $"{nombres?[0]?.Substring(0, 1)}{apellidos?[0]?.Substring(0, 1)}";
                                                    }
                                                    <div class="rounded-circle bg-purple text-white d-flex align-items-center justify-content-center" 
                                                         style="width: 40px; height: 40px; font-weight: bold;">
                                                        @iniciales
                                                    </div>
                                                </div>
                                                <div>
                                                    <strong>
                                                        @estudiante.Nombres @estudiante.Apellidos
                                                        @if (isCurrentUser)
                                                        {
                                                            <span class="badge bg-info ms-2">Tú</span>
                                                        }
                                                    </strong>
                                                    <br><small class="text-muted">@estudiante.Email</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-center py-3">
                                            <span class="badge bg-success fs-6 px-3 py-2">
                                                <i class="bi bi-star-fill"></i> @estudiante.PuntajeTotal pts
                                            </span>
                                        </td>
                                        <td class="text-center py-3">
                                            @if (estudiante.IdNivel != null)
                                            {
                                                <span class="badge bg-info text-white px-3 py-2">Nivel @estudiante.IdNivel</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary px-3 py-2">Sin nivel</span>
                                            }
                                        </td>
                                        <td class="text-center py-3">
                                            <span class="badge bg-warning text-dark fs-6 px-3 py-2">
                                                <i class="bi bi-award-fill"></i> @estudiante.MedallasCount
                                            </span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas generales -->
    <div class="row mt-4">
        <div class="col-md-4 mb-3">
            <div class="@(User.IsInRole("Estudiante") ? "perfil-section" : "card border-0 shadow-sm")">
                <div class="@(User.IsInRole("Estudiante") ? "" : "card-body") text-center">
                    <i class="bi bi-people-fill text-primary" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 mb-2">Total Estudiantes</h5>
                    <h2 class="text-primary mb-0">@Model.Count</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="@(User.IsInRole("Estudiante") ? "perfil-section" : "card border-0 shadow-sm")">
                <div class="@(User.IsInRole("Estudiante") ? "" : "card-body") text-center">
                    <i class="bi bi-star-fill text-success" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 mb-2">Puntaje Promedio</h5>
                    @{
                        var promedio = Model.Count > 0 ? 
                            Model.Sum((Func<dynamic, int>)(x => x.PuntajeTotal)) / Model.Count : 0;
                    }
                    <h2 class="text-success mb-0">@promedio pts</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="@(User.IsInRole("Estudiante") ? "perfil-section" : "card border-0 shadow-sm")">
                <div class="@(User.IsInRole("Estudiante") ? "" : "card-body") text-center">
                    <i class="bi bi-award-fill text-warning" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 mb-2">Medallas Totales</h5>
                    <h2 class="text-warning mb-0">@Model.Sum((Func<dynamic, int>)(x => x.MedallasCount))</h2>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info text-center p-5">
                <i class="bi bi-info-circle" style="font-size: 4rem;"></i>
                <h4 class="mt-4">No existen registros en el ranking</h4>
                <p class="mb-0">Aún no hay estudiantes con puntajes registrados en el sistema.</p>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        // Scroll automático a la fila del usuario actual
        @if (User.IsInRole("Estudiante"))
        {
            <text>
            document.addEventListener('DOMContentLoaded', function() {
                var currentUserRow = document.querySelector('.table-active');
                if (currentUserRow) {
                    currentUserRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });
            </text>
        }
    </script>
}
